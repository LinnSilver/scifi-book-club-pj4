<!-- book_details.html -->
{% extends 'base.html' %}

{% block content %}
<section id="main">
    <h2>{{ book.title }}</h2>
    <p>Title: {{ book.book_title }}</p>
    <p>Author: {{ book.book_author }}</p>
    <p>About: {{ book.book_description }}</p>
    <p>Likes</p>
</section>

<!-- Content for logged-in users -->
<section id="comment">
  {% if user.is_authenticated %}
    <div>
        <h2>Welcome, {{ user.username }}!</h2>
        <p>What did you think about this book?</p>
        <h2>Like to leave a comment?</h2>
        <form id="comment-form" method="post" action="{% url 'add_comment' book_id=book.id %}">
          {% csrf_token %}
          {{ form.as_p }}
        
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        
        <script>
          $(document).ready(function() {
            $('#comment-form').submit(function(event) {
              event.preventDefault(); // Prevent the form from submitting normally
        
              var form = $(this);
              var url = form.attr('action');
              var formData = form.serialize();
        
              // Submit the form using AJAX
              $.ajax({
                type: 'POST',
                url: url,
                data: formData,
                success: function(response) {
                  // Reload the page after successful submission
                  location.reload();
                },
                error: function(xhr) {
                  // Handle errors and display an error message
                  Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'An error occurred while submitting the comment. Please try again.',
                  });
                }
              });
            });
          });
        </script>
        
    </div>
    <div>
      <p>Rating</p>
    </div>

    <section id="comments">
    <div>
      <h2>Comments:</h2>
      {% for comment in comments reversed %}
        <div>
          <p>{{ comment.user.username }} says:</p>
          <p>{{ comment.content }}</p>
          {% if user.is_authenticated and user == comment.user %}
            <form method="post" action="{% url 'delete_comment' comment_id=comment.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          {% endif %}
        </div>
      {% empty %}
        <p>No comments yet.</p>
      {% endfor %}
    </div>
  {% else %}
    <div>
        <!-- Content for non-logged-in users -->
        <p>Please log in to leave a comment.</p>
    </div>
  {% endif %}
  </section>
</section>
{% endblock %}
